{% import 'utility/icons.html.twig' as icon %}

<!DOCTYPE html>
<html class="h-100">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>{% block title %}Welcome!{% endblock %}</title>
        {# Run `composer require symfony/webpack-encore-bundle`
           and uncomment the following Encore helpers to start using Symfony UX #}
        {% block stylesheets %}
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.0.2/dist/lumen/bootstrap.min.css" integrity="sha256-2zyNvUTezoJ3p/Kd78Ia/B5+UdtRtlQeRJSmFlHEn6Q=" crossorigin="anonymous">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
            <link href="https://cdn.jsdelivr.net/npm/tom-select@2.1.0/dist/css/tom-select.css" rel="stylesheet">
            <link rel="stylesheet" href="{{ asset("icomoon/style.css") }}">
            <link href="{{ asset("build/app.css") }}">
        {% endblock %}

        {% block javascripts %}
            <script src="https://d3js.org/d3.v7.min.js"></script>
            {{ encore_entry_script_tags('app') }}
        {% endblock %}

        <style rel="stylesheet">
            label.required:after {
                content: "* ";
            }

            .text-light span.icon .path1:before {
                color: #f6f6f6;
            }

            .text-light span.icon .path2:before {
                color: #777777;
            }


            .list-group.list-group-root {
                padding: 0;
                overflow: hidden;
            }

            .list-group.list-group-root .list-group {
                margin-bottom: 0;
            }

            .list-group.list-group-root .list-group-item {
                border-radius: 0;
                border-width: 1px 0 0 0;
            }

            .list-group.list-group-root > .list-group-item:first-child {
                border-top-width: 0;
            }

            .list-group.list-group-root > .list-group > .list-group-item {
                padding-left: 40px;
            }

            .list-group.list-group-root > .list-group > .list-group > .list-group-item {
                padding-left: 80px;
            }

            .list-group.list-group-root > .list-group > .list-group > .list-group > .list-group-item {
                padding-left: 120px;
            }

            .list-group.list-group-root > .list-group > .list-group > .list-group > .list-group .list-group-item {
                padding-left: 160px;
            }

            .list-group.list-group-root > .list-group > .list-group > .list-group > .list-group > .list-group .list-group-item {
                padding-left: 200px;
            }
        </style>
    </head>
    <body class="h-100">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="{{ url("app_homepage") }}">Gin {% if app.request.server.get('GENIE_VERSION') %} (v{{ app.request.server.get('GENIE_VERSION') }}){% endif %}</a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                {% if app.user %}
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="border-end border-1 my-2" style="border-color: rgb(255, 255, 255, 0.55) !important;"></li>

                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="{{ url("app_cells") }}" id="navbar-dropdown-cell-link" role="button" data-toggle="dropdown" aria-haspopup="true">
                                    {{ icon.cell() }}
                                    Cells
                                </a>

                                <div class="dropdown-menu" aria-labelledby="navbar-dropdown-cell-link">
                                    <a class="dropdown-item" href="{{ url("app_cells") }}">{{ icon.cell() }}Overview</a>
                                    <a class="dropdown-item" href="{{ url("app_cells_all") }}">{{ icon.cell() }}All cells</a>
                                    <a class="dropdown-item" href="{{ url("app_cell_add") }}"><span class="fas fa-fw fa-plus"></span>Add cell</a>

                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="{{ url("app_cell_cultures") }}"><span class="fas fa-fw fa-flask"></span>Cell Cultures</a>
                                </div>
                            </li>

                            <li class="border-end border-1 my-2" style="border-color: rgb(255, 255, 255, 0.55) !important;"></li>

                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="{{ url("app_antibodies") }}" id="navbar-dropdown-antibody-link" role="button" data-toggle="dropdown" aria-haspopup="true">
                                    {{ icon.antibody() }}
                                    Antibodies
                                </a>

                                <div class="dropdown-menu" aria-labelledby="navbar-dropdown-antibody-link">
                                    <a class="dropdown-item" href="{{ url("app_antibodies") }}"><span class="fas fa-fw"></span>All</a>
                                    <a class="dropdown-item" href="{{ url("app_antibodies", {"antibodyType": "primaries"}) }}">{{ icon.antibody_primary() }} Primaries</a>
                                    <a class="dropdown-item" href="{{ url("app_antibodies", {"antibodyType": "secondaries"}) }}">{{ icon.antibody_secondary() }} Secondaries</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="{{ url("app_substance_new", {"type": "antibody"}) }}"><span class="fas fa-fw fa-plus"></span>New Antibody</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="{{ url("app_epitopes") }}">{{ icon.epitope() }}Epitopes</a>
                                </div>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link" href="{{ url("app_compounds") }}">
                                    {{ icon.chemical() }}
                                    Chemicals
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link" href="{{ url("app_oligos") }}">
                                    {{ icon.oligo() }}
                                    Oligos
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link" href="{{ url("app_plasmids") }}">
                                    {{ icon.plasmid() }}
                                    Plasmids
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link" href="{{ url("app_proteins") }}">
                                    {{ icon.protein() }}
                                    Proteins
                                </a>
                            </li>

                            <li class="border-end border-1 my-2" style="border-color: rgb(255, 255, 255, 0.55) !important;"></li>

                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="{{ url("app_storage") }}"  id="navbar-dropdown-storage-link" role="button" data-toggle="dropdown" aria-haspopup="true">
                                    {{ icon.rack() }}
                                    Storage
                                </a>

                                <div class="dropdown-menu" aria-labelledby="navbar-dropdown-storage-link">
                                    <a class="dropdown-item" href="{{ url("app_storage_add_rack") }}">
                                        {{ icon.add(false) }}
                                        {{ icon.rack(false) }}
                                        New Location
                                    </a>
                                    <a class="dropdown-item" href="{{ url("app_storage_add_box") }}">
                                        {{ icon.add() }}
                                        {{ icon.box() }}
                                        New Box
                                    </a>
                                </div>
                            </li>

                            <li class="nav-item">
                            </li>

                            <li class="nav-item">
                                <a class="nav-link" href="{{ url("app_instruments") }}">
                                    <span class="fas fa-fw fa-hdd"></span>
                                    Instruments
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link" href="{{ url("app_experiments") }}">
                                    <span class="fas fa-fw fa-flask"></span>
                                    Experiments
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link" href="{{ url("app_recipes") }}">
                                    <span class="fas fa-fw fa-list-alt"></span>
                                    Recipes
                                </a>
                            </li>

                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbar-dropdown-user-link" role="button" data-toggle="dropdown" aria-haspopup="true">
                                    <span class="fas fa-fw fa-user"></span>
                                    User
                                </a>

                                <div class="dropdown-menu" aria-labelledby="navbar-dropdown-user-link">
                                    <a class="dropdown-item" href="{{ url("admin") }}"><span class="fas fa-fw fa-tools"></span> Administration</a>
                                    <a class="dropdown-item" href="{{ logout_url(key = null) }}"><span class="fas fa-sign-out-alt fa-fw"></span> Logout</a>
                                </div>
                            </li>
                        </ul>

                        {% block search %}{% endblock %}
                    </div>
                {% endif %}
            </div>
        </nav>

        {% block body %}{% endblock %}

        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/tom-select@2.1.0/dist/js/tom-select.complete.min.js"></script>

        <script src="https://unpkg.com/smiles-drawer@1.2.0/dist/smiles-drawer.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jquery.fancytable/dist/fancyTable.min.js"></script>
        <script src="https://unpkg.com/html5-qrcode"></script>

        <script type="application/javascript">
            $(document).ready(function() {
                let shownOnRequest;

                shownOnRequest = localStorage.getItem("shownOnRequest");

                if (!shownOnRequest) {
                    shownOnRequest = {};
                } else {
                    shownOnRequest = JSON.parse(shownOnRequest);
                }

                $('.collapse').on("shown.bs.collapse", function(e) {
                    let id = $(this).attr('id');
                    shownOnRequest[id] = 1;
                    localStorage.setItem("shownOnRequest", JSON.stringify(shownOnRequest));

                    return true;
                }).on("hidden.bs.collapse", function(e) {
                    let id = $(this).attr('id');

                    shownOnRequest[id] = 0;
                    localStorage.setItem("shownOnRequest", JSON.stringify(shownOnRequest));

                    return true;
                });

                $("a[data-bs-toggle^='tab']").on("shown.bs.tab", function(e) {
                    let id = $(this).attr('id');
                    shownOnRequest[id] = 1;
                    localStorage.setItem("shownOnRequest", JSON.stringify(shownOnRequest));

                    return true;
                }).on("hidden.bs.tab", function(e) {
                    let id = $(this).attr('id');

                    shownOnRequest[id] = 0;
                    localStorage.setItem("shownOnRequest", JSON.stringify(shownOnRequest));

                    return true;
                })

                let collapsible = null;
                for (let id in shownOnRequest) {
                    if (shownOnRequest[id] === 1) {
                        collapsible = $("#" + id);
                        if (collapsible.length > 0 && collapsible.hasClass("navbar-collapse") === false && collapsible.css("display") === "none") {
                            let bsCollapse = new bootstrap.Collapse(collapsible).show();

                            console.log($(`[href^='#${id}'] > .collapse-icon`, collapsible.parent()));
                            /*$(`[href^='#gin-storage-01GGVPMNS7F2KBVHCFSYZ43VGC'] > .collapse-icon`, collapsible.parent())
                                .toggleClass('fa-plus-square')
                                .toggleClass('fa-minus-square');*/
                        } else if (collapsible.length > 0 && collapsible.hasClass("nav-link")) {
                            collapsible.tab("show");
                        }
                    }
                }

                $("input.gin-datetime-autofill[type^=datetime-local]").each(function (i, e) {
                    now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    now.setMilliseconds(null)
                    now.setSeconds(null)

                    e.valueAsDate = now;
                    //e.value = e.value.slice(0,16);
                    //console.log(e.value.slice(0, 16));
                })

                $(function() {
                    $('.list-group').on('shown.bs.collapse', function(e) {
                        let id = this.id;

                        if (e.target === this) {
                            $(`#anchor-for-${id} > .collapse-icon`, this.parentElement)
                                .toggleClass('fa-plus-square')
                                .toggleClass('fa-minus-square');
                        }
                    }).on('hidden.bs.collapse', function(e) {
                        let id = this.id;

                        if (e.target === this) {
                            $(`#anchor-for-${id} > .collapse-icon`, this.parentElement)
                                .toggleClass('fa-plus-square')
                                .toggleClass('fa-minus-square');
                        }
                    });
                });
            });
        </script>

        <script type="application/javascript">
            $(function () {
                $('[data-toggle="tooltip"]').tooltip({"html": true})
            });

            $(function(){
                $('.dropdown').hover(function(e) {
                        $(this).addClass('show');
                        $(this).children("a.dropdown-toggle").attr("aria-expanded", "true");
                        $(this).children(".dropdown-menu").addClass("show");
                    },
                    function() {
                        $(this).removeClass('show');
                        $(this).children("a.dropdown-toggle").attr("aria-expanded", "false");
                        $(this).children(".dropdown-menu").removeClass("show");
                    });
            });

            let form_accordions = $("div.accordion-item");
            form_accordions.has(".is-invalid").addClass("border-warning");

            $(document).ready(function() {
                /*$(".fancyTable").fancyTable({
                    sortColumn: 1,
                    pagination: true,
                    perPage: 30,
                    globalSearch: true,
                    globalSearchExcludeColumns: [0],
                });*/

                $(".fancyTable").each(function (e) {
                    let sortColumn = 1;

                    if (this.hasAttribute("data-ft-sort-column")) {
                        sortColumn = this.getAttribute("data-ft-sort-column");
                    }

                    $(this).fancyTable({
                        sortColumn: sortColumn,
                        pagination: true,
                        perPage: 30,
                        globalSearch: true,
                        globalSearchExcludeColumns: [0],
                    })
                })
            });
        </script>
        <script type="application/javascript">
            new ClipboardJS('.btn-clipboard');
        </script>
        <script type="application/javascript">
            let canvas = $('[data-smiles-type="small"]');
            let options = {
                width: 100,
                height: 100,
                bondThickness: 1.0,
                bondLength: 10,
                shortBondLength: 0.6,
                bondSpacing: 0.25 * 10,
                fontSizeLarge: 6,
                fontSizeSmall: 4,
                padding: 20.0,
            };

            // Initialize the drawer to draw to canvas
            let smilesDrawer = new SmilesDrawer.Drawer(options);
            // Alternatively, initialize the SVG drawer:
            // let svgDrawer = new SmilesDrawer.SvgDrawer(options);

            canvas.each(function(index, canvas) {
                SmilesDrawer.parse(canvas.dataset.smiles, function(tree) {
                    smilesDrawer.draw(tree, canvas, "light", false)
                })
            })

            let largeCanvas = $('[data-smiles-type="large');
            let largeOptions = {width: 200, height: 200,
                bondThickness: 1.0,
                bondLength: 10,
                shortBondLength: 0.6,
                bondSpacing: 0.25 * 10,
                fontSizeLarge: 6,
                fontSizeSmall: 4,
                padding: 20.0,}

            // Initialize the drawer to draw to canvas
            let largeSmilesDrawer = new SmilesDrawer.Drawer(largeOptions);
            // Alternatively, initialize the SVG drawer:
            // let svgDrawer = new SmilesDrawer.SvgDrawer(options);

            largeCanvas.each(function(index, canvas) {
                console.log(canvas)
                console.log(canvas.dataset.smiles)
                SmilesDrawer.parse(canvas.dataset.smiles, function(tree) {
                    largeSmilesDrawer.draw(tree, canvas, "light", false)
                })
            })
        </script>

        <script type="application/javascript">
            $(document).ready(function() {
                $("select.gin-fancy-select").each(function (e) {
                    new TomSelect(this, {
                        plugins: {
                            dropdown_input: true,
                        },
                        maxOptions: 1000,
                        sortField:[{field: 'text'}, {field: '$order'}, {field: '$score'}],
                        create: !!this.attributes["data-allow-add"],
                        allowEmptyOption: this.attributes["data-allow-empty"] && this.attributes["data-allow-empty"].value === "true",
                        render: {
                            optgroup_header: function(data, escape) {
                                return '<div class="optgroup-header"><strong>' + escape(data.label) + '</strong></div>';
                            },
                            option: function(data, escape) {
                                if (data.optgroup === undefined) {
                                    return '<div>' + escape(data.text) + '</div>';
                                } else {
                                    return '<div class="ps-3">' + escape(data.text) + '</div>';
                                }
                            },
                        }
                    })
                })
            })
        </script>

        <script src="https://cdn.jsdelivr.net/gh/calipho-sib/sequence-viewer@master/dist/sequence-viewer.min.js"></script>
        <script type="application/javascript">
            $(document).ready(function () {
                let viewers = $(".gin-sequenceViewer")

                viewers.each(function (e) {
                    let sequence = new Sequence(this.innerText);

                    sequence.render("#" + this.id, {
                        'showLineNumbers': true,
                        'wrapAminoAcids': true,
                        'charsPerLine': 100,
                        'toolbar': true,
                        'search': true,
                        'title': this.hasAttribute("data-gin-sequence-title") ? this.getAttribute("data-gin-sequence-title") : "Sequence Viewer",
                        'header' : {
                            display:true,
                            searchInTitle :true,
                            unit: "Char",
                            showCpl: false,
                            badgeWithUnit : false
                        }
                    })
                })
            });
        </script>

        {% block script_bottom %}{% endblock %}
    </body>
</html>
